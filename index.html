<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Painel Gerencial - Cidade Sol</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
}
header {
  background: #0b2545;
  padding: 10px 20px;
}
header img {
  height: 50px;
}
nav {
  display: flex;
  background: #163a63;
}
nav button {
  flex: 1;
  padding: 15px;
  border: none;
  background: none;
  color: white;
  font-size: 16px;
  cursor: pointer;
}
nav button.active {
  background: #0b2545;
  font-weight: bold;
}
section {
  display: none;
  padding: 20px;
}
section.active {
  display: block;
}
.controls {
  margin-bottom: 15px;
}
select, button, input {
  padding: 8px;
  margin-right: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 14px;
  text-align: center;
}
th {
  background: #eee;
}
.error {
  color: red;
  font-weight: bold;
}
.positivo { color: green; font-weight: bold; }
.negativo { color: red; font-weight: bold; }

/* STATUS OCORRÃŠNCIAS */
.status-tratado {
  background-color: #d4edda;
  color: #155724;
  font-weight: bold;
}
.status-nao-tratado {
  background-color: #f8d7da;
  color: #721c24;
  font-weight: bold;
}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="Cidade Sol">
</header>

<nav>
  <button class="active" onclick="showTab('ocorrencias', this)">Resumo OcorrÃªncias</button>
  <button onclick="showTab('os', this)">Resumo OS</button>
  <button onclick="showTab('linhas', this)">Resumo de Linhas</button>
</nav>

<!-- ================= OCORRÃŠNCIAS ================= -->
<section id="ocorrencias" class="active">
  <h2>Resumo de OcorrÃªncias</h2>

  <div class="controls">
    <input type="month" id="mesOcorrencia">
    <button onclick="buscarOcorrencias()">Buscar</button>
  </div>

  <canvas id="graficoMotoristas" height="120"></canvas>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Motorista</th>
        <th>Resumo</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tabelaOcorrencias"></tbody>
  </table>
</section>

<!-- ================= OS ================= -->
<section id="os">
  <h2>Resumo OS - ManutenÃ§Ã£o</h2>

  <div class="controls">
    <input type="month" id="mesOS">
    <button onclick="buscarOS()">Buscar</button>
  </div>

  <div id="resumoOS"></div>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Fiscal</th>
        <th>NÂº Ordem</th>
        <th>ObservaÃ§Ã£o</th>
        <th>NÂº OS</th>
      </tr>
    </thead>
    <tbody id="tabelaOS"></tbody>
  </table>
</section>

<!-- ================= RESUMO DE LINHAS ================= -->
<section id="linhas">
  <h2>Resumo de Linhas</h2>

  <div class="controls">
    <select id="anoLinhas"></select>
    <select id="mesLinhas"></select>
    <select id="grupoLinhas">
      <option value="todos">Todos os Grupos</option>
      <option>Grupo Alagoinhas</option>
      <option>Grupo RecÃ´ncavo</option>
      <option>Grupo Regional</option>
    </select>
    <button onclick="buscarLinhas()">Buscar</button>
  </div>

  <div class="controls">
    <label><input type="checkbox" checked value="Linha"> Linha</label>
    <label><input type="checkbox" checked value="Receita"> Receita</label>
    <label><input type="checkbox" checked value="Km_Rodado"> Km Rodado</label>
    <label><input type="checkbox" checked value="Qtd_Pax"> Pax</label>
    <label><input type="checkbox" checked value="R$/KM"> R$/KM</label>
  </div>

  <table>
    <thead id="theadLinhas"></thead>
    <tbody id="tbodyLinhas"></tbody>
  </table>
</section>

<script>
/* ================== URLs DAS APIs ================== */
const URL_OCORRENCIAS = "https://script.google.com/macros/s/AKfycbxhq42uCNBiYz8_AhOVUMYKsZwBLohidhBs1PCHfihIMaM9En-gwcBm3M_JUwqrVITZ/exec";
const URL_OS = "https://script.google.com/macros/s/AKfycbyKVm2k3rYD7WoDkPAaJ3kEsn7lPYccpnt0zY-ISrbXhMx3WLkrzvs8Q8jYT8kAbjT7/exec";

/* ðŸ‘‰ NOVA API â€“ RESUMO DE LINHAS */
const URL_LINHAS = "https://script.google.com/macros/s/AKfycbz77iuV4v_zR8Qnw5Slw34mUHRxtz_k6GhfcQ8BmILY_cjKwNbh4gynvcs8ba-Ozhe3TA/exec";

let grafico;
let dadosLinhas = [];

/* ================= NAVEGAÃ‡ÃƒO ================= */
function showTab(id, btn) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  btn.classList.add("active");
}

/* ================= OCORRÃŠNCIAS ================= */
async function buscarOcorrencias() {
  const mes = mesOcorrencia.value;
  tabelaOcorrencias.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";

  const res = await fetch(`${URL_OCORRENCIAS}?aba=Resumo_ocorrencias&mes=${mes}`);
  const data = await res.json();

  tabelaOcorrencias.innerHTML = "";
  const contagem = {};

  data.forEach(o => {
    const status = (o.Status || "").toLowerCase();
    const classe = status === "tratado" ? "status-tratado" :
                   status.includes("nao") ? "status-nao-tratado" : "";

    tabelaOcorrencias.innerHTML += `
      <tr>
        <td>${o.Data || ""}</td>
        <td>${o.Motorista || ""}</td>
        <td>${o.Resumo || ""}</td>
        <td class="${classe}">${o.Status || ""}</td>
      </tr>`;
    contagem[o.Motorista] = (contagem[o.Motorista] || 0) + 1;
  });

  const top5 = Object.entries(contagem).sort((a,b)=>b[1]-a[1]).slice(0,5);

  if (grafico) grafico.destroy();
  grafico = new Chart(graficoMotoristas, {
    type: "bar",
    data: {
      labels: top5.map(i => i[0]),
      datasets: [{ data: top5.map(i => i[1]) }]
    }
  });
}

/* ================= OS ================= */
async function buscarOS() {
  const mes = mesOS.value;
  tabelaOS.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

  const res = await fetch(`${URL_OS}?mes=${mes}`);
  const dados = await res.json();

  resumoOS.innerHTML = `<strong>Total de OS:</strong> ${dados.length}`;
  tabelaOS.innerHTML = "";

  dados.forEach(o => {
    tabelaOS.innerHTML += `
      <tr>
        <td>${o.Data || ""}</td>
        <td>${o.Fiscal || ""}</td>
        <td>${o["NÂº de Ordem"] || ""}</td>
        <td>${o.ObservaÃ§Ã£o || ""}</td>
        <td>${o["NÂº da OS"] || ""}</td>
      </tr>`;
  });
}

/* ================= LINHAS ================= */
fetch(URL_LINHAS)
  .then(r => r.json())
  .then(d => {
    dadosLinhas = d.map(l => ({
      ...l,
      Ano: +l.Ano,
      MÃªs: +l.MÃªs,
      Receita: +l.Receita,
      Km_Rodado: +l.Km_Rodado,
      Qtd_Pax: +l.Qtd_Pax,
      "R$/KM": +l["R$/KM"]
    }));
    carregarFiltrosLinhas();
  });

function carregarFiltrosLinhas() {
  const anos = [2024, 2025, 2026, 2027];
  const meses = [
    {v:1, t:"Janeiro"}, {v:2, t:"Fevereiro"}, {v:3, t:"MarÃ§o"},
    {v:4, t:"Abril"}, {v:5, t:"Maio"}, {v:6, t:"Junho"},
    {v:7, t:"Julho"}, {v:8, t:"Agosto"}, {v:9, t:"Setembro"},
    {v:10, t:"Outubro"}, {v:11, t:"Novembro"}, {v:12, t:"Dezembro"}
  ];

  anoLinhas.innerHTML = "";
  mesLinhas.innerHTML = "";

  anos.forEach(a => {
    anoLinhas.innerHTML += `<option value="${a}">${a}</option>`;
  });

  meses.forEach(m => {
    mesLinhas.innerHTML += `<option value="${m.v}">${m.t}</option>`;
  });

  // Seleciona automaticamente o mÃªs/ano atual
  const hoje = new Date();
  anoLinhas.value = hoje.getFullYear();
  mesLinhas.value = hoje.getMonth() + 1;
}

function buscarLinhas() {
  const ano = +anoLinhas.value;
  const mes = +mesLinhas.value;
  const grupo = grupoLinhas.value;
  const campos = [...document.querySelectorAll("#linhas input:checked")].map(c => c.value);

  const filtrado = dadosLinhas.filter(l =>
    l.Ano === ano &&
    l.MÃªs === mes &&
    (grupo === "todos" || l.Grupo === grupo)
  );

  theadLinhas.innerHTML =
    "<tr>" + campos.map(c => `<th>${c}</th>`).join("") + "<th>Î” R$/KM</th></tr>";

  tbodyLinhas.innerHTML = "";

  filtrado.forEach(l => {
    const ant = dadosLinhas.find(a =>
      a.Linha === l.Linha && a.MÃªs === mes && a.Ano === ano - 1
    );

    const diff = ant
      ? ((l["R$/KM"] - ant["R$/KM"]) / ant["R$/KM"]) * 100
      : null;

    tbodyLinhas.innerHTML += `
      <tr>
        ${campos.map(c => `<td>${l[c]}</td>`).join("")}
        <td class="${diff >= 0 ? "positivo" : "negativo"}">
          ${diff === null ? "-" : diff.toFixed(1) + "%"}
        </td>
      </tr>`;
  });
}

/* ================= DATAS PADRÃƒO ================= */
const hoje = new Date().toISOString().slice(0,7);
mesOcorrencia.value = hoje;
mesOS.value = hoje;
</script>

</body>
</html>
